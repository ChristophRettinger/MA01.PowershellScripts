# MA01 PowerShell Scripts

This repository contains a collection of PowerShell scripts used within the MA01 environment. Each script helps automate a specific operational or analysis task.

## Scripts

All scripts are located under the `Scripts` folder, each in its own subfolder named after the script (without the `.ps1` extension).

- **Add-HostNames.ps1** - Reads a CSV file of IP addresses, resolves host names via DNS, and writes an enriched CSV with the host name added.
- **Analyze-RagMetadata.ps1** - Processes RAG usage metadata from a JSON file, computing statistical summaries and field frequency counts.
- **Analyze-OrchestraPsc.ps1** - Reviews Orchestra scenario PSC archives, extracts configured process model field values, and writes a consolidated XML status report.
- **Extract-ChatProperties.ps1** - Extracts selected properties from chat metadata JSON and outputs a simplified JSON file containing only those fields.
- **Start-HttpListener.ps1** - Hosts a lightweight HTTP/HTTPS listener that logs inbound requests to files.
- **Test-Connections.ps1** - Tests TCP connectivity to hosts specified in a CSV file, records the result for each host, and updates the file with resolved IP addresses.
- **Process-MissingADM.ps1** - Queries ADM changelog data (orch.CHANGE_LOG_TAB_SAV via STO_STAMP date filters) for a date range and compares CL_ID values with Elasticsearch documents filtered by `BK.SUBFL_messagetype:AdmRecord`, `BK.SUBFL_stage:Input`, and `Environment:production`. Uses `ElasticApiKey` or `ElasticApiKeyPath` (default `.\elastic.key`; Elasticsearch is always queried) with optional time range expansion via `IncreaseElasticDateRange` (default 4 hours). Writes missing IDs found in the database but not Elasticsearch to the script's Output directory.
- **Process-MissingMedarchiv.ps1** - Queries changelog data for a date range and compares with Elasticsearch to find missing records. Defaults to today's full day if `StartDate` is omitted. Use `Anstalt` with a specific ID or `All` to process all mappings; results are presented as a single table. Elasticsearch is optional via `-IncludeElastic` and uses `ElasticUrl` + `ElasticApiKey` or `ElasticApiKeyPath` (default `.\elastic.key`). Also supports `MappingCsvPath`, `ElasticTimeField`, and `IncreaseElasticDateRange` (expands ES time window +/- N hours; default 4). The mapping CSV must include columns `Anstalt,DatabaseName,ElasticName` (example provided under `Scripts/Process-MissingMedarchiv/DatabaseMappings.csv`).
- **Evaluate-OrchestraErrorsViaElastic.ps1** - Retrieves failed Orchestra scenarios from Elasticsearch (with substring matching on `ScenarioName`), groups error messages, optionally writes matching documents to formatted XML files, and normalizes error text via configurable regex replacements that can include optional conditions. Files produced by the `All` and `OneOfType` modes include the timestamp, the original error text, selected business keys, and the message payload embedded as XML nodes (optionally filtered via the `MessagePart` parameter, which keeps `Data` elements whose `@src` attribute starts with the provided value). `All` writes one XML file per occurrence, while `OneOfType` writes only the first occurrence for each normalized error. File names combine the run date, a sequential counter, and the first 20 characters of the normalized error. The `Environment` parameter defaults to `production`, and `ElasticApiKeyPath` defaults to `.\elastic.key`. Note: The script posts JSON with the correct `Content-Type` header; if you previously saw a 406 "Content-Type header [application/x-www-form-urlencoded] is not supported", update to the current version.
- **Evaluate-AdmKavideErrors.ps1** - Retrieves Elasticsearch errors for the `ITI_SUBFL_KAVIDE_speichern_v01_3287` scenario within a date range, environment, and optional instance using two phases: a first search gathers only `ERROR` workflow events to discover case numbers, then each case is queried separately for full event details. Summaries include first error details (timestamp, BusinessCaseId, status text, and `ZugangVonKostenstelle` extracted from MessageData1), a JSON list of all errors per case (including `ZugangVonKostenstelle`), and counts of workflow successes grouped by `BK.SUBFL_subid`, `BK.SUBFL_category`, and `BK.SUBFL_subcategory`. Console output highlights each case with its timestamp range, successes, and individual error details in color, with progress bars indicating collection and per-case processing. An ignore list text file can be supplied to skip errors containing matching phrases. Results are printed and exported to CSV. `ElasticApiKeyPath` defaults to `.\elastic.key`.
- **Get-PatientInfo.ps1** - Fetches production SUBFL HCM messages for a patient or case (optionally filtered by movement), stitches together historic PIDs discovered in `BK._PID_ISH_OLD`, and splits the console output into ERROR and non-ERROR segments. When a case number is supplied, results stay scoped to the requested case while still including patient-level records that do not contain case identifiers. Within each segment, results are grouped by case, category, subcategory, change type, and workflow pattern with Input and Output stage ranges (outputs further grouped by `BK.SUBFL_party`). A brief header lists PID(s) plus case/movement identifiers alongside BusinessCaseId/MSGID and AID. Results are exported to JSON in the script's `Output` folder.
- **Transfer-OperationData.ps1** - Copies rows from `BiztalkApplicationData.dbo.DataStore` into the OrchestraOperationData database by calling `dbo.StoreOperationData_v1`. Each execution resumes from the last processed `DataStoreId` recorded in a JSON configuration file, processes up to a caller-specified maximum in 100-row batches, pauses between batches, and displays progress while updating the stored state once per successfully committed batch.

## Shared utilities

- **Scripts/Common/ElasticSearchHelpers.ps1** - Hosts `Invoke-ElasticScrollSearch`, a reusable helper that issues scroll queries, aggregates all hits, surfaces detailed error information, and optionally reports page progress for callers. Scripts such as Process-MissingMedarchiv and Evaluate-OrchestraErrorsViaElastic dot-source this file to keep Elasticsearch pagination logic consistent.

## Documentation references

- **SubflElasticInfo.md** - Overview of Subscription Flow (SUBFL) terminology plus how SUBFL scenarios log to Elasticsearch, including the specific fields and filters leveraged by the SUBFL-related scripts in this repository.
